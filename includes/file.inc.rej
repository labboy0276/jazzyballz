--- includes/file.inc
+++ includes/file.inc
@@ -475,6 +475,26 @@
  *   already present. Defaults to FALSE.
  */
 function file_create_htaccess($directory, $private = TRUE, $force_overwrite = FALSE) {
+
+  // Test the web server identity.
+  if (!isset($_SERVER['SERVER_SOFTWARE'])) {
+    // Skip this in Drush where SERVER_SOFTWARE is not set and .htaccess never used anyway.
+    $use_htaccess = FALSE;
+  }
+  elseif (isset($_SERVER['SERVER_SOFTWARE']) && preg_match("/Nginx/i", $_SERVER['SERVER_SOFTWARE'])) {
+    $use_htaccess = FALSE;
+  }
+  elseif (isset($_SERVER['SERVER_SOFTWARE']) && preg_match("/Apache/i", $_SERVER['SERVER_SOFTWARE'])) {
+    $use_htaccess = TRUE;
+  }
+  else {
+    $use_htaccess = FALSE;
+  }
+
+  if (!$use_htaccess) {
+    return;
+  }
+
   if (file_uri_scheme($directory)) {
     $directory = file_stream_wrapper_uri_normalize($directory);
   }
